<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .chart-container { width: 100%; height: 400px; margin: 20px 0; }
        .debug-info { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Battery History Chart Debug</h1>
    
    <div class="debug-info">
        <h3>Debug Information</h3>
        <div id="debugInfo">Loading...</div>
    </div>
    
    <button onclick="loadData()">Load Real Data</button>
    <button onclick="loadSampleData()">Load Sample Data</button>
    <button onclick="clearChart()">Clear Chart</button>
    
    <div class="chart-container">
        <canvas id="debugChart"></canvas>
    </div>
    
    <div class="debug-info">
        <h3>Chart Status</h3>
        <div id="chartStatus">Not initialized</div>
    </div>

    <script>
        let chart = null;
        
        function initChart() {
            const ctx = document.getElementById('debugChart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Battery Level (%)',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Current Draw (mA)',
                            data: [],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'MMM dd'
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Battery Level (%)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Current Draw (mA)'
                            }
                        }
                    }
                }
            });
            
            updateStatus('Chart initialized');
        }
        
        async function loadData() {
            try {
                updateStatus('Loading real data...');
                const response = await fetch('/api/battery-history?range=today');
                const data = await response.json();
                
                updateDebugInfo(`Loaded ${data.history?.length || 0} data points`);
                
                if (data.history && data.history.length > 0) {
                    const batteryData = [];
                    const drainData = [];
                    
                    data.history.forEach(point => {
                        const timestamp = new Date(point.timestamp);
                        
                        batteryData.push({
                            x: timestamp,
                            y: point.battery_level
                        });
                        
                        if (point.current_draw > 0) {
                            drainData.push({
                                x: timestamp,
                                y: point.current_draw
                            });
                        }
                    });
                    
                    chart.data.datasets[0].data = batteryData;
                    chart.data.datasets[1].data = drainData;
                    chart.update();
                    
                    updateStatus(`Chart updated with ${batteryData.length} battery points, ${drainData.length} drain points`);
                } else {
                    updateStatus('No data available');
                }
                
            } catch (error) {
                updateStatus('Error loading data: ' + error.message);
                console.error('Error:', error);
            }
        }
        
        function loadSampleData() {
            updateStatus('Loading sample data...');
            
            const now = new Date();
            const batteryData = [];
            const drainData = [];
            
            for (let i = 0; i < 24; i++) {
                const time = new Date(now.getTime() - (24 - i) * 60 * 60 * 1000);
                const battery = 100 - (i * 3) - Math.random() * 5;
                const drain = 400 + Math.random() * 200;
                
                batteryData.push({ x: time, y: Math.max(0, battery) });
                drainData.push({ x: time, y: drain });
            }
            
            chart.data.datasets[0].data = batteryData;
            chart.data.datasets[1].data = drainData;
            chart.update();
            
            updateStatus(`Sample data loaded: ${batteryData.length} points`);
        }
        
        function clearChart() {
            chart.data.datasets[0].data = [];
            chart.data.datasets[1].data = [];
            chart.update();
            updateStatus('Chart cleared');
        }
        
        function updateStatus(message) {
            document.getElementById('chartStatus').textContent = message;
            console.log('Status:', message);
        }
        
        function updateDebugInfo(message) {
            document.getElementById('debugInfo').textContent = message;
            console.log('Debug:', message);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            updateDebugInfo('Chart debug page loaded');
        });
    </script>
</body>
</html>